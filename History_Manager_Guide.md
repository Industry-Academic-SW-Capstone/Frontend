# 기획서: PWA를 위한 이중 레이어 히스토리 관리 시스템

## 1\. 개요 (Overview)

SPA(Single Page Application) 기반의 PWA 환경, 특히 안드로이드(Galaxy)의 하드웨어 뒤로가기 버튼 사용 시 발생하는 \*\*"앱 종료 현상"\*\*과 \*\*"네비게이션 혼선"\*\*을 해결하기 위한 아키텍처입니다.
앱의 네비게이션을 \*\*Depth(맥락)\*\*와 \*\*Step(화면 내 이동)\*\*의 2차원 구조로 분리하여 관리하며, 사용자에게 **Native App과 동일한 UX**를 제공하는 것을 목표로 합니다.

## 2\. 핵심 컨셉 (Core Concepts)

이 시스템은 네비게이션을 두 가지 차원으로 정의합니다.

### A. Depth (맥락의 깊이) - `Stack` 구조

- **정의:** 완전히 새로운 화면이나 맥락(Context)으로의 진입을 의미합니다.
- **비유:** 책장에서 **새로운 책을 꺼내 펼치는 행위**입니다.
- **동작:**
  - 새로운 Depth가 열리면 이전 Depth는 **"일시 정지(Frozen)"** 상태가 되며, 당시의 상태(마지막으로 보던 페이지)를 기억합니다.
  - 뒤로가기로 현재 Depth가 닫히면, 이전 Depth가 \*\*"재개(Resume)"\*\*되며 기억해 둔 페이지가 복원됩니다.
- **예시:** `메인 탭` $\rightarrow$ `주식 상세 정보` $\rightarrow$ `매수 주문 창`

### B. Step (화면 내 이동) - `Sequence` 구조

- **정의:** 현재 Depth(맥락) 안에서의 선형적인 페이지 이동을 의미합니다.
- **비유:** 펼쳐진 책 내에서 **페이지를 한 장씩 넘기는 행위**입니다.
- **동작:**
  - 사용자의 이동 경로가 순차적으로 기록됩니다.
  - 뒤로가기 시, 바로 이전 페이지(Step)로 되돌아갑니다.
- **예시:** `차트 보기(p1)` $\rightarrow$ `재무 정보 보기(p2)` $\rightarrow$ `뉴스 보기(p3)`

---

## 3\. 데이터 구조 (Data Structure)

이 로직을 지탱하는 상태(State) 모델입니다. \*\*"스택 안에 스택이 있는 구조"\*\*를 가집니다.

```json
[
  // Depth 1: 메인 화면 (Bottom Layer)
  {
    "depthId": "main_home",
    "stepHistory": [0, 1, 2] // 사용자가 0->1->2 순서로 이동함. 현재 위치: 2
  },

  // Depth 2: 상세 화면 (Top Layer - Active)
  {
    "depthId": "stock_detail",
    "stepHistory": [0, 1] // 사용자가 0->1 순서로 이동함. 현재 위치: 1
  }
]
```

---

## 4\. 로직 흐름 (Logic Flow)

사용자의 행동(Input)에 따른 시스템의 처리 로직(Process)입니다.

### 4.1. 전진 (Forward Navigation)

1.  **Step 이동 (같은 맥락 내 이동)**

    - **Action:** 사용자가 [다음] 버튼 클릭 또는 스와이프.
    - **Logic:** 현재 활성화된(가장 위쪽) Depth의 `stepHistory` 배열에 새로운 인덱스를 추가(`push`).
    - **Browser:** `history.pushState()` 실행 (뒤로가기 방어권 획득).

2.  **Depth 진입 (새로운 맥락 열기)**

    - **Action:** 사용자가 [상세보기], [글쓰기] 등의 진입 버튼 클릭.
    - **Logic:** 전체 `Stack`에 새로운 Depth 객체를 생성하여 추가(`push`). 초기 Step은 보통 0으로 설정.
    - **Browser:** `history.pushState()` 실행.

### 4.2. 후진 (Backward Navigation) - 하드웨어 버튼 감지

브라우저의 `popstate` 이벤트 발생 시, 시스템은 현재 상태를 보고 다음 두 가지 중 하나를 수행합니다.

**Case A: 현재 Depth에 돌아갈 Step이 남아있는 경우 (Step Back)**

> "책을 덮지 않고 이전 페이지로 넘김"

- **조건:** 현재 Depth의 `stepHistory` 길이가 1보다 클 때.
- **동작:**
  1.  `stepHistory`의 마지막 항목을 제거(`pop`).
  2.  남아있는 마지막 항목(이전 페이지)을 현재 페이지로 설정.
  3.  **UI 반영:** Swiper를 이전 인덱스로 이동 (애니메이션 포함).

**Case B: 현재 Depth의 첫 페이지인 경우 (Depth Back)**

> "다 읽은 책을 덮고, 아래에 있던 책을 다시 펼침"

- **조건:** `stepHistory` 길이가 1일 때 (더 이상 뒤로 갈 Step이 없음).
- **동작:**
  1.  현재 Depth 객체 자체를 전체 Stack에서 제거(`pop`).
  2.  이제 최상단이 된 **이전 Depth**를 활성화.
  3.  **상태 복원(Restore):** 이전 Depth의 `stepHistory` 마지막 값을 확인하여 그 위치로 이동.
  4.  **UI 반영:** 화면(View) 자체를 전환하고, Swiper 위치를 복구 (깜빡임 최소화).

**Case C: 모든 Depth와 Step이 소진된 경우**

- **조건:** Stack에 Depth가 1개뿐이고, 그 Depth의 Step도 0번일 때.
- **동작:** 앱 종료 (브라우저 기본 동작 허용).

---

## 5\. 시나리오 예시 (User Scenarios)

사용자 **김개미**씨가 `StockIt!` 앱을 사용하는 상황입니다.

| 순서 | 사용자 행동                 | 내부 로직 (State)                                                                        | 화면 변화                             |
| :--- | :-------------------------- | :--------------------------------------------------------------------------------------- | :------------------------------------ |
| 1    | **앱 실행**                 | Depth: `[Main]` <br> Step: `[0]`                                                         | 메인 홈 화면                          |
| 2    | **'랭킹' 탭 이동** (Step)   | Depth: `[Main]` <br> Step: `[0, 1]`                                                      | 랭킹 화면으로 슬라이드 됨             |
| 3    | **'삼성전자' 클릭** (Depth) | Depth: `[Main, Detail]` <br> Step(Main): `[0, 1]` (보존) <br> Step(Detail): `[0]` (신규) | 삼성전자 상세 화면 열림               |
| 4    | **'재무제표' 보기** (Step)  | Depth: `[Main, Detail]` <br> Step(Detail): `[0, 1]`                                      | 재무제표 탭으로 슬라이드 됨           |
| 5    | **[뒤로가기] 버튼 클릭**    | **(Case A 발동)** <br> Step(Detail)에서 `1` 제거. `0` 복귀.                              | 다시 삼성전자 상세 첫 화면            |
| 6    | **[뒤로가기] 버튼 클릭**    | **(Case B 발동)** <br> Detail Depth 제거. <br> Main Depth의 마지막 `1` 확인.             | **랭킹 화면(Step 1)으로 정확히 복귀** |
| 7    | **[뒤로가기] 버튼 클릭**    | **(Case A 발동)** <br> Step(Main)에서 `1` 제거. `0` 복귀.                                | 메인 홈 화면                          |

---

## 6\. 개발 시 고려사항 (Implementation Note)

1.  **싱글톤 동기화 (Singleton Sync):**
    - 모든 히스토리 로직은 전역 상태 관리자(Zustand Store) 한 곳에서만 처리되어야 합니다. UI 컴포넌트는 오직 "명령(Go/Back)"만 내리고 스스로 상태를 판단하지 않습니다.
2.  **브라우저 히스토리 1:1 매핑:**
    - 내부 로직의 Depth/Step 추가 시점과 `window.history.pushState` 시점이 반드시 1:1로 일치해야 꼬이지 않습니다.
3.  **복원 시점의 UX (Restoration UX):**
    - Depth가 복구될 때(상위 화면으로 돌아갈 때), Swiper가 `0 -> 저장된 위치`로 이동하는 애니메이션이 보이면 사용자 경험이 좋지 않습니다. 복원 시에는 애니메이션 없이 즉시 이동(`duration: 0`) 처리가 필요합니다.
